# handlers/help.py

import logging
from aiogram import types, Dispatcher, Bot
from aiogram.utils.exceptions import MessageNotModified
from keyboards.submenus import help_menu_keyboard
from keyboards.main_menu import main_menu_keyboard
from functools import partial

logger = logging.getLogger(__name__)

async def show_help_callback(callback: types.CallbackQuery, bot: Bot):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü–æ–º–æ—â—å" –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é.
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ.
    """
    help_text = (
        "üìö *English Learning Bot* üìö\n\n"
        "–ë–æ—Ç –ø–æ–º–æ–∂–µ—Ç –≤–∞–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏–∑—É—á–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞. –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã:\n\n"
        
        "üìå *–°–ª–æ–≤–∞ –¥–Ω—è* ‚Äî –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Å–ª–æ–≤–∞ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏\n"
        "üìù *–¢–µ—Å—Ç –¥–Ω—è* ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞–Ω–∏—è —Å–ª–æ–≤\n"
        "üìñ *–ú–æ–π —Å–ª–æ–≤–∞—Ä—å* ‚Äî –≤–∞—à–∏ –≤—ã—É—á–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞\n"
        "üèãÔ∏è *–ü—Ä–∞–∫—Ç–∏–∫–∞* ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏\n"
        "üè† *–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è* ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞\n\n"
        
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:"
    )
    
    try:
        await callback.message.edit_text(
            help_text,
            parse_mode="Markdown",
            reply_markup=help_menu_keyboard()
        )
    except MessageNotModified:
        logger.debug(f"Help message not modified for user {callback.from_user.id}")
        pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
    except Exception as e:
        logger.error(f"Error editing help message for user {callback.from_user.id}: {e}")
        # –í —Å–ª—É—á–∞–µ –¥—Ä—É–≥–æ–π –æ—à–∏–±–∫–∏, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        try:
            await bot.send_message(
                callback.from_user.id,
                help_text,
                parse_mode="Markdown",
                reply_markup=help_menu_keyboard()
            )
        except Exception as send_error:
            logger.error(f"Failed to send fallback help message: {send_error}")
    
    await callback.answer()

async def process_help_about_callback(callback: types.CallbackQuery, bot: Bot):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û –±–æ—Ç–µ" –∏–∑ –º–µ–Ω—é –ø–æ–º–æ—â–∏.
    """
    about_text = (
        "‚ÑπÔ∏è *–û –±–æ—Ç–µ –∏ –∫–∞–∫ –∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è* ‚ÑπÔ∏è\n\n"
        
        "*üéØ –ì–ª–∞–≤–Ω–∞—è –∏–¥–µ—è:*\n"
        "–ë–æ—Ç –ø–æ–º–æ–≥–∞–µ—Ç —É—á–∏—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞ –º–∞–ª–µ–Ω—å–∫–∏–º–∏ –ø–æ—Ä—Ü–∏—è–º–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å\n\n"
        
        "*üìö –ß—Ç–æ —Ç–∞–∫–æ–µ –Ω–∞–±–æ—Ä —Å–ª–æ–≤?*\n"
        "–≠—Ç–æ –≥–æ—Ç–æ–≤–∞—è –ø–æ–¥–±–æ—Ä–∫–∞ –∏–∑ ~50 –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤ –ø–æ —Ç–µ–º–∞–º –∏ —É—Ä–æ–≤–Ω—è–º.\n"
        "–ü—Ä–∏–º–µ—Ä—ã:\n"
        "‚Ä¢ ¬´A1 Basic 1¬ª ‚Äî –±–∞–∑–æ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö (~50 —Å–ª–æ–≤)\n"
        "‚Ä¢ ¬´B1 Travel¬ª ‚Äî —Å–ª–æ–≤–∞ –ø—Ä–æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è (~50 —Å–ª–æ–≤)\n"
        "‚Ä¢ ¬´B2 Business¬ª ‚Äî –±–∏–∑–Ω–µ—Å –ª–µ–∫—Å–∏–∫–∞ (~50 —Å–ª–æ–≤)\n\n"
        
        "*üîÑ –ö–∞–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–±—É—á–µ–Ω–∏–µ:*\n"
        "1Ô∏è‚É£ –£—Ç—Ä–æ–º –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –ø–æ—Ä—Ü–∏—é —Å–ª–æ–≤ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞\n"
        "2Ô∏è‚É£ –í —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è —Å–ª–æ–≤–∞ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö\n"
        "3Ô∏è‚É£ –í–µ—á–µ—Ä–æ–º –ø—Ä–æ—Ö–æ–¥–∏—Ç–µ —Ç–µ—Å—Ç –¥–Ω—è\n"
        "4Ô∏è‚É£ ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã ‚Üí —Å–ª–æ–≤–∞ –≤ –≤–∞—à —Å–ª–æ–≤–∞—Ä—å\n"
        "5Ô∏è‚É£ ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ ‚Üí –ø–æ–≤—Ç–æ—Ä—è—Ç—Å—è –∑–∞–≤—Ç—Ä–∞\n\n"
        
        "*üí° –ö–æ–≥–¥–∞ –≤—ã—É—á–∏—Ç–µ –≤–µ—Å—å –Ω–∞–±–æ—Ä (~50 —Å–ª–æ–≤):*\n"
        "–ë–æ—Ç –ø–µ—Ä–µ–π–¥–µ—Ç –≤ —Ä–µ–∂–∏–º –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –∏–∑—É—á–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤\n"
        "–∏–ª–∏ –≤—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –Ω–æ–≤—ã–π –Ω–∞–±–æ—Ä –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö"
    )
    
    try:
        await callback.message.edit_text(
            about_text,
            parse_mode="Markdown",
            reply_markup=help_menu_keyboard()
        )
    except MessageNotModified:
        logger.debug(f"About message not modified for user {callback.from_user.id}")
        pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
    except Exception as e:
        logger.error(f"Error editing about message for user {callback.from_user.id}: {e}")
        try:
            await bot.send_message(
                callback.from_user.id,
                about_text,
                parse_mode="Markdown",
                reply_markup=help_menu_keyboard()
            )
        except Exception as send_error:
            logger.error(f"Failed to send fallback about message: {send_error}")
    
    await callback.answer()
    
async def process_help_commands_callback(callback: types.CallbackQuery, bot: Bot):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–†–∞–∑–¥–µ–ª—ã –±–æ—Ç–∞" –∏–∑ –º–µ–Ω—é –ø–æ–º–æ—â–∏.
    """
    commands_text = (
        "üîç *–†–∞–∑–¥–µ–ª—ã –±–æ—Ç–∞* üîç\n\n"
        
        "üìå *–°–ª–æ–≤–∞ –¥–Ω—è*\n"
        "–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤ –∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π.\n\n"
        
        "üìù *–¢–µ—Å—Ç –¥–Ω—è*\n"
        "–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∑–Ω–∞–Ω–∏–µ –≤–∞—à–∏—Ö —Å–ª–æ–≤ –¥–Ω—è. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ —Å–ª–æ–≤–∞—Ä—å.\n\n"
        
        "üìñ *–ú–æ–π —Å–ª–æ–≤–∞—Ä—å*\n"
        "–í—Å–µ –≤—ã—É—á–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞. –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ –Ω–∞–±–æ—Ä–∞ —Å–ª–æ–≤.\n\n"
        
        "üèãÔ∏è *–ü—Ä–∞–∫—Ç–∏–∫–∞*\n"
        "–¢–µ—Å—Ç—ã –ø–æ —Å–ª–æ–≤–∞—Ä—é –∏ —Ä–µ–∂–∏–º –∑–∞—É—á–∏–≤–∞–Ω–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–ª–æ–≤ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞.\n\n"
        
        "üè† *–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è*\n"
        "–£—Ä–æ–≤–µ–Ω—å, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤, —á–∞—Å—Ç–æ—Ç–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π, –Ω–∞–±–æ—Ä —Å–ª–æ–≤, —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å."
    )
    
    try:
        await callback.message.edit_text(
            commands_text,
            parse_mode="Markdown",
            reply_markup=help_menu_keyboard()
        )
    except MessageNotModified:
        logger.debug(f"Commands message not modified for user {callback.from_user.id}")
        pass
    except Exception as e:
        logger.error(f"Error editing commands message for user {callback.from_user.id}: {e}")
        try:
            await bot.send_message(
                callback.from_user.id,
                commands_text,
                parse_mode="Markdown",
                reply_markup=help_menu_keyboard()
            )
        except Exception as send_error:
            logger.error(f"Failed to send fallback commands message: {send_error}")
    
    await callback.answer()

async def process_help_tips_callback(callback: types.CallbackQuery, bot: Bot):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–æ–≤–µ—Ç—ã" –∏–∑ –º–µ–Ω—é –ø–æ–º–æ—â–∏.
    """
    tips_text = (
        "üí° *–°–æ–≤–µ—Ç—ã –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è* üí°\n\n"
        
        "‚úÖ –ü—Ä–æ—Ö–æ–¥–∏—Ç–µ —Ç–µ—Å—Ç—ã –¥–Ω—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ\n"
        "‚úÖ –ù–∞—á–Ω–∏—Ç–µ —Å 4-6 —Å–ª–æ–≤ –≤ –¥–µ–Ω—å\n"
        "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 2-3 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π\n"
        "‚úÖ –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å–ª–æ–≤–∞—Ä—å\n"
        "‚úÖ –ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ —Ç–µ—Å—Ç—ã –ø–æ –Ω–∞–±–æ—Ä—É –∏ —Å–ª–æ–≤–∞—Ä—é\n"
        "‚úÖ –ò–∑—É—á–∞–π—Ç–µ —Ä–∞–∑–Ω—ã–µ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤\n"
        "‚úÖ –ò–∑—É—á–∞–π—Ç–µ —É—Ä–æ–≤–Ω–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (A1‚ÜíA2‚ÜíB1...)\n"
        "‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –ø—Ä–æ—Ñ–∏–ª–µ\n\n"
        
        "*–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –Ω–∞—á–∞–ª–∞:*\n"
        "‚Ä¢ –£—Ä–æ–≤–µ–Ω—å: –≤–∞—à —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –≤–ª–∞–¥–µ–Ω–∏—è —è–∑—ã–∫–æ–º\n"
        "‚Ä¢ –°–ª–æ–≤ –≤ –¥–µ–Ω—å: 5\n"
        "‚Ä¢ –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–π: 3"
    )
    
    try:
        await callback.message.edit_text(
            tips_text,
            parse_mode="Markdown",
            reply_markup=help_menu_keyboard()
        )
    except MessageNotModified:
        logger.debug(f"Tips message not modified for user {callback.from_user.id}")
        pass
    except Exception as e:
        logger.error(f"Error editing tips message for user {callback.from_user.id}: {e}")
        try:
            await bot.send_message(
                callback.from_user.id,
                tips_text,
                parse_mode="Markdown",
                reply_markup=help_menu_keyboard()
            )
        except Exception as send_error:
            logger.error(f"Failed to send fallback tips message: {send_error}")
    
    await callback.answer()

async def process_help_feedback_callback(callback: types.CallbackQuery, bot: Bot):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å" –∏–∑ –º–µ–Ω—é –ø–æ–º–æ—â–∏.
    """
    feedback_text = (
        "‚úâÔ∏è *–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å* ‚úâÔ∏è\n\n"
        "–£ –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è?\n\n"
        
        "‚Ä¢ Telegram: @username\n"
        "‚Ä¢ Email: support@example.com\n\n"
        
        "–ú—ã —Ä–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –±–æ—Ç–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –æ—Ç–∑—ã–≤–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."
    )
    
    try:
        await callback.message.edit_text(
            feedback_text,
            parse_mode="Markdown",
            reply_markup=help_menu_keyboard()
        )
    except MessageNotModified:
        logger.debug(f"Feedback message not modified for user {callback.from_user.id}")
        pass
    except Exception as e:
        logger.error(f"Error editing feedback message for user {callback.from_user.id}: {e}")
        try:
            await bot.send_message(
                callback.from_user.id,
                feedback_text,
                parse_mode="Markdown",
                reply_markup=help_menu_keyboard()
            )
        except Exception as send_error:
            logger.error(f"Failed to send fallback feedback message: {send_error}")
    
    await callback.answer()

def register_help_handlers(dp: Dispatcher, bot: Bot):
    """
    –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–µ–Ω—é –ø–æ–º–æ—â–∏.
    """
    dp.register_callback_query_handler(
        partial(show_help_callback, bot=bot),
        lambda c: c.data == "menu:help"
    )
    dp.register_callback_query_handler(
        partial(process_help_about_callback, bot=bot),
        lambda c: c.data == "help:about"
    )
    dp.register_callback_query_handler(
        partial(process_help_commands_callback, bot=bot),
        lambda c: c.data == "help:commands"
    )
    dp.register_callback_query_handler(
        partial(process_help_tips_callback, bot=bot),
        lambda c: c.data == "help:tips"
    )
    dp.register_callback_query_handler(
        partial(process_help_feedback_callback, bot=bot),
        lambda c: c.data == "help:feedback"
    )